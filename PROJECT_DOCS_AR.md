# توثيق مشروع Thamarat-BackEnd (ثمرات)

## نظرة عامة
**Thamarat-BackEnd** هو تطبيق يعتمد على إطار عمل Spring Boot ويعمل كواجهة خلفية (Backend) لمنصة "ثمرات" / "اربح مالاً". يتيح التطبيق للمستخدمين كسب النقاط من خلال آلية "العداد"، مشاهدة الإعلانات، شراء بطاقات رقمية، وسحب الأرباح.

## الهيكلية التقنية (Architecture)
- **إطار العمل**: Spring Boot (Java).
- **قاعدة البيانات**: JPA / Hibernate (H2 أو MySQL).
- **الأمان**: Spring Security + JWT.
- **النمط المعماري**: Controller -> Service -> Repository.

## الوحدات الأساسية (Core Modules)

### 1. المصادقة والمستخدمين (`UsersController`, `UserAuthService`)
- **التسجيل**: يسجل المستخدمون باستخدام اسم المستخدم، كلمة المرور، رمز الإحالة، ورمز التفعيل.
- **تسجيل الدخول**: يتم إرجاع رمز JWT لإدارة الجلسة.
- **الأدوار (Roles)**: `ROLE_USER` (مستخدم عادي) و `ROLE_ADMIN` (مسوؤل).
- **الميزات**:
    - التحقق من البريد الإلكتروني (رمز التفعيل).
    - استعادة كلمة المرور / إعادة تعيين كلمة المرور.
    - تحديد معدل الطلبات (Rate Limiting) لرموز التفعيل باستخدام مكتبة `Bucket4j`.

### 2. نظام العدادات (`CounterService`, `CounterController`)
الآلية الأساسية لكسب النقاط.
- **العدادات (Counters)**: عناصر افتراضية تولد النقاط.
    - الخصائص: ساعات التهدئة (`CooldownHours`)، السعر (`Price`)، مدفوع/مجاني.
- **عداد المستخدم (`UserCounter`)**: يمثل العداد الذي يملكه المستخدم.
    - **المستويات**: العدادات لها مستويات/باقات تحدد "النقاط لكل ضغطة".
    - **آلية العمل**: يقوم المستخدم "بتشغيل" العداد. يعمل العداد لعدد معين من الساعات. بعد الانتهاء، يعود المستخدم للضغط عليه مرة أخرى لتحصيل النقاط وإعادة تشغيله.
- **العداد المجاني**: يحصل كل مستخدم على عداد مجاني عند التسجيل إذا كان متاحاً.
- **المتجر**: يمكن للمستخدمين شراء عدادات مميزة باستخدام النقاط.

### 3. المتجر والبطاقات (`StoreService`, `StoreController`)
سوق للسلع الرقمية (مثل بطاقات الهدايا).
- **البطاقات**: منتجات لها سعر (بالنقاط)، فئة، وصورة.
- **الشراء**:
    - ينفق المستخدمون النقاط لشراء البطاقات.
    - يتم إنشاء طلب شراء (`CardPurchase`).
    - يقوم المسؤول بمراجعة الطلب ووضع علامة "تم التسليم" مع إرسال الكود (`DeliveredCode`).
- **الصور**: تخزن كمصفوفة بايتات (`byte[]`) في قاعدة البيانات، ويتم ضغطها/فك ضغطها باستخدام `ImageUtilities`.

### 4. النظام المالي (`FinancialService`, `FinancialController`)
يدير اقتصاد التطبيق.
- **السحب (Withdraw)**: يمكن للمستخدمين طلب سحب النقاط وتحويلها لأموال حقيقية (زين كاش، ماستركارد).
    - الطلبات تكون قيد المراجعة من قبل المسؤول.
    - يمكن للمسؤول الموافقة أو الرفض (مع إعادة النقاط).
- **التحويل (Transfer)**: تحويل النقاط بين المستخدمين (باستخدام اسم المستخدم أو رمز الإحالة).
- **سجلات العمليات (`LogTransaction`)**: يتم تسجيل جميع الحركات المالية لغرض التدقيق.

### 5. الإعلانات (`AdsService`, `AdsController`)
- إدارة بسيطة لكيانات الإعلانات التي تظهر في الواجهة الأمامية.

## نظرة عامة على واجهات برمجة التطبيقات (API Endpoints)

### المصادقة (`/api/users`)
- `POST /register`: تسجيل مستخدم جديد.
- `POST /login`: تسجيل الدخول (يتم التعامل معه غالباً بواسطة Spring Security filter).
- `POST /activecode`: إرسال رمز التفعيل للبريد الإلكتروني.
- `POST /forgot_password`: بدء عملية استعادة كلمة المرور.

### العداد (`/api/counter`)
- `GET /mycounters`: جلب عدادات المستخدم.
- `POST /action/{id}`: تشغيل/تحصيل نقاط العداد.
- `GET /store`: عرض العدادات المتاحة للبيع.
- `POST /buy/{id}`: شراء عداد.

### المتجر (`/api/store`)
- `GET /cards`: عرض البطاقات المتاحة.
- `POST /buy/{id}`: شراء بطاقة.
- `GET /getimage/{id}`: جلب صورة البطاقة.

### المالية (`/api/financial`)
- `POST /withdraw`: طلب سحب رصيد.
- `POST /transfer`: تحويل نقاط.

### لوحة المسؤول (Admin)
- إدارة المستخدمين (حظر/تفعيل).
- إدارة العدادات (إضافة/تعديل).
- الموافقة على السحوبات وشراء البطاقات.

## نماذج البيانات (Data Models)
- **UserAuth**: كيان المستخدم الرئيسي.
- **Counter**: تعريف نوع العداد.
- **UserCounter**: نسخة العداد المملوكة للمستخدم.
- **CardProduct**: منتج في المتجر.
- **Withdraw**: طلب سحب الرصيد.
- **LogTransaction**: سجل تدقيق للنقاط.

## الأدوات المساعدة (Utilities)
- **ImageUtilities**: أداة مساعدة لضغط/فك ضغط الصور لتخزينها في قاعدة البيانات.
